# 基于凸方法和非凸方法的矩阵填充实验报告

---

## 一、研究背景与数据集说明

在现代推荐系统中，用户–物品评分矩阵通常具有两个显著特征：

1. **高度稀疏**：绝大多数用户仅对极少数物品进行过评分；
2. **潜在低秩结构**：用户偏好与物品属性可由少量潜在因子刻画。

矩阵填充问题正是基于上述特征提出，其核心目标是在**仅观测部分矩阵元素**的条件下，恢复完整评分矩阵。

**MovieLens 10M**数据集是推荐系统研究中广泛使用的基准数据集之一，包含来自约71,567名匿名用户对10,677部电影的1,000万条评分记录（评分范围为1-5星），构成了一个极端稀疏的用户-电影评分矩阵（密度仅为约1.31%），该数据集具有真实用户行为的长尾分布和时序特征，常被用于评估协同过滤与矩阵补全算法的性能，为研究提供了规模适中且具有代表性的实验数据基础。

本实验基于此数据集，分别采用：

- soft-impute的凸方法
- AM的非凸方法

并通过 **5 折交叉验证** 比较两种方法的表现。

---

## 二、问题建模与算法理论

### 2.1 矩阵补全问题形式化

设 $M \in \mathbb{R}^{n \times m}$ 为用户-电影评分矩阵，其中 $n$ 为用户数量，$m$ 为电影数量。矩阵元素 $$M_{ij}$$ 表示用户 $i$ 对电影 $j$ 的评分（1-5分），但仅在索引集合 $$\Omega$$ 上可观测，其余元素缺失。矩阵补全问题旨在利用观测到的部分评分，预测缺失的评分值。

该问题可以形式化为以下带秩约束的优化问题：

$$\[
\min_{X} \sum_{(i,j) \in \Omega} (X_{ij} - M_{ij})^2 \quad \text{s.t.} \quad \text{rank}(X) \leq r
\]$$

其中 $X$ 为待补全的矩阵，$r$ 为预设的秩上限。秩约束是非凸的，直接求解困难。

### 2.2 Soft-Impute 方法

给定一个稀疏矩阵 $R \in \mathbb{R}^{m \times n}$，其中包含部分观测值，Soft-Impute旨在找到一个低秩矩阵 $X$，最小化以下目标函数：

$$
\min_X \frac{1}{2} \|P_\Omega(X - R)\|_F^2 + \lambda \|X\|_*
$$

其中：
- $$P_\Omega$$ 是观测位置的投影算子
- $$\|\cdot\|_F$$ 是Frobenius范数
- $$\|\cdot\|_*$$ 是核范数（奇异值之和）
- $$\lambda$$ 是正则化参数

**优化过程**：
算法采用迭代软阈值SVD方法：

1. 初始化： $$X^{(0)} = P_\Omega(R)$$ 
2. 迭代更新：
   
   $$
   X^{(k+1)} = S_\lambda\left(X^{(k)} + P_\Omega(R - X^{(k)})\right)
   $$
   
   其中 $$S_\lambda(Z) = U \cdot \text{diag}((\sigma_i - \lambda)_+) \cdot V^T$$ 是软阈值算子

4. 收敛条件： $$\|X^{(k+1)} - X^{(k)}\|_F / \|X^{(k)}\|_F < \epsilon$$ 

### 2.3 AM 方法

交替最小化（Alternating Minimization, AM）方法通过在固定其中一个因子矩阵的条件下，交替优化另一个因子矩阵，将原始的非凸优化问题分解为一系列带正则化的最小二乘子问题。

模型目标函数形式如下：

$$
\min_{U,V} \sum_{(u,i)\in\Omega} \left(r_{ui} - U_u^\top V_i\right)^2 + \lambda \left( \|U\|_F^2 + \|V\|_F^2 \right)
$$

其中， $U \in \mathbb{R}^{n \times r}$ 与 $V \in \mathbb{R}^{m \times r}$ 分别表示用户与物品的潜在因子矩阵， $r$ 为矩阵分解秩（rank）， $\lambda$ 为正则化参数。
 
---

## 三、实验设计

### 3.1 Soft-Impute 方法

#### 数据预处理

1. **数据读取与缓存**：
   - 首次加载时解析`ratings.dat`文件，建立用户ID与电影ID的连续索引映射
   - 将评分数据转换为CSR格式稀疏矩阵并缓存至`sparse_matrix_cache.npz`
   - 后续运行直接加载缓存文件，减少重复计算

2. **矩阵统计量计算**：
   - 全局均值（`global_mean`）：所有评分的平均值
   - 用户均值（`row_means`）：每个用户的平均评分
   - 电影均值（`col_means`）：每部电影的平均评分

3. **矩阵中心化**：
      - 计算用户平均评分： $$r_i = \frac{1}{n_i} \sum_{j \in \Omega_i} R_{ij}$$ 
   - 计算电影平均评分： $$c_j = \frac{1}{m_j} \sum_{i \in \Omega_j} R_{ij}$$ 
   - 中心化： $$R_{ij}^c = R_{ij} - r_i - c_j + \mu$$ 
   - 其中 $$\mu$$ 是全局平均评分

#### 参数设置

奇异值分析
1. 对中心化后的矩阵进行SVD分解（支持随机SVD加速）
2. 计算奇异值累积能量分布，评估矩阵低秩特性
3. 根据最大奇异值动态确定正则化参数λ的候选范围：
   - 最大奇异值>1000：λ范围为最大奇异值的0.01%~10%
   - 100<最大奇异值≤1000：λ范围为最大奇异值的0.1%~100%
   - 最大奇异值≤100：λ范围为最大奇异值的1%~1000%

基于奇异值分析和实验经验确定参数：

| 参数 | 设置值 | 选择依据 |
|------|--------|----------|
| **最大秩（max_rank）** | 20 | 根据奇异值分析，前20个奇异值累积能量占比超过66.9%，能够捕获大部分数据变异 |
| **λ搜索范围** | 基于奇异值分析自动确定 | 根据最大奇异值（288.271）的比例确定，覆盖从0.1%到2000%的范围，确保搜索充分 |
| **最大迭代次数（max_iter）** | 25 | 实验发现迭代20-25次已充分收敛，增加次数对性能提升有限 |
| **收敛阈值（convergence_thresh）** | 3e-4 | 平衡精度和计算效率，更小的阈值会增加计算时间但改进有限 |
| **使用随机SVD（use_randomized_svd）** | True | 处理大规模矩阵（69,878×10,677）时，随机SVD比传统SVD快10倍以上 |
| **随机SVD迭代次数（svd_iterations）** | 7 | 提供足够的精度，同时保持计算效率 |
| **随机种子（random_state）** | 42 | 确保结果可重复性 |

#### 交叉验证方案

采用五折交叉验证评估模型性能：
- 将评分数据随机分为5等份
- 每次使用4份作为训练集，1份作为测试集
- 重复5次，计算平均性能指标

#### 评估指标

1. **均方根误差（RMSE）**：
 
   $$
   \text{RMSE} = \sqrt{\frac{1}{N} \sum_{i=1}^N (y_i - \hat{y}_i)^2}
   $$

3. **平均绝对误差（MAE）**：

   $$
   \text{MAE} = \frac{1}{N} \sum_{i=1}^N |y_i - \hat{y}_i|
   $$

5. **裁剪后RMSE**：将预测值裁剪到[1.0, 5.0]区间后重新计算RMSE


### 3.2 AM方法



---


## 四、实验结果及分析

### 4.1 Soft-Impute 方法

#### 奇异值分析

通过对训练矩阵进行奇异值分解，得到以下关键信息：
- **最大奇异值**：288.271（表明数据变化幅度较大）
- **奇异值衰减**：前50个奇异值占总能量的100%
- **确定 $$\lambda$$ 范围**：根据最大奇异值的大小，将 $$\lambda$$ 设置为最大奇异值的不同比例（0.1%-2000%）

#### 不同 $$\lambda$$ 值的性能比较

从五折交叉验证结果可以看出：

|  $\lambda$  | 平均RMSE | RMSE标准差 | 裁剪后RMSE | 平均MAE | 平均时间(秒) |
|-----------|----------|------------|------------|---------|--------------|
| 0.288 | 0.811944 | 0.000453 | 0.811944 | 0.617626 | 841.3 |
| 2.883 | 0.811306 | 0.000457 | 0.811306 | 0.617332 | 830.7 |
| **14.414** | **0.809567** | **0.000474** | **0.809567** | **0.616817** | 839.2 |
| 28.827 | 0.809938 | 0.000492 | 0.809938 | 0.618010 | 844.1 |
| 144.136 | 0.859031 | 0.000524 | 0.859031 | 0.660845 | 839.9 |
| ≥288.271 | 0.885061 | 0.000534 | 0.885061 | 0.682678 | ~42.0 |

**关键发现**：

1. **最优 $$\lambda$$ 值**： $$\lambda = 14.414$$ 时取得最佳RMSE（0.809567）
2. **性能趋势**：
   - 当 $$\lambda$$ 较小时（0.288-28.827），模型性能相近
   - 当 $$\lambda$$ 达到144.136时，性能显著下降（RMSE增加约6%）
   - 当 $$\lambda \geq 288.271$$ 时，模型完全收缩为零矩阵（有效秩为0）
3. **时间效率**：大 $$\lambda$$ 值收敛极快（仅需1次迭代），但性能较差

#### 收敛行为分析

观察不同 $$\lambda$$ 值的迭代过程：

1. **小 $$\lambda$$ 值（<30）**：
   - 有效秩保持为20（最大设置值）
   - 能量保留率>90%
   - 需要25次迭代达到收敛
   - 变化量逐渐减小

2. **中等 $$\lambda$$ 值（144.136）**：
   - 有效秩降至7-10
   - 能量保留率约30%
   - 仍需要多次迭代收敛

3. **大 $$\lambda$$ 值（≥288.271）**：
   - 有效秩为0（所有奇异值被截断）
   - 一次迭代即收敛
   - 预测结果为偏置矩阵（行均值+列均值-全局均值）

#### 模型稳定性

- **低标准差**：各 $$\lambda$$ 值的RMSE标准差在0.0005以内，表明五折交叉验证结果稳定
- **性能一致性**：各折的RMSE值非常接近，最小0.808771，最大0.812554




### 4.2 AM方法
---

## 五、结论与讨论

